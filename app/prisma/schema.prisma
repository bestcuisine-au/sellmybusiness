generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String?
  phone         String?
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  accounts      Account[]
  sessions      Session[]
  businesses    Business[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
}

model Business {
  id          String   @id @default(cuid())
  userId      String
  
  name        String
  industry    String
  subIndustry String?
  location    String
  state       String
  postcode    String
  
  askingPrice     Decimal?
  annualRevenue   Decimal?
  annualProfit    Decimal?
  establishedYear Int?
  employees       Int?
  
  description     String?
  highlights      String[]
  assetsIncluded  String?
  reasonForSale   String?
  
  aiPriceGuide    Json?
  aiDescription   String?
  aiInfoMemo      String?
  
  status      BusinessStatus @default(DRAFT)
  tier        PricingTier    @default(STARTER)
  views       Int            @default(0)
  inquiries   Int            @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  expiresAt   DateTime?
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  inquiriesList Inquiry[]
  infoMemo      InfoMemo?
  prospects     Prospect[]
  memoData      InfoMemoData?
  imSections    IMSection[]
  imViews       IMView[]
  imAccess      IMAccess[]
  
  @@index([status, industry])
  @@index([location, state])
}

model Inquiry {
  id         String   @id @default(cuid())
  businessId String
  
  name       String
  email      String
  phone      String?
  message    String
  ndaSigned  Boolean  @default(false)
  
  status     InquiryStatus @default(NEW)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String?
  createdAt DateTime @default(now())
}

enum BusinessStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  SOLD
  EXPIRED
  WITHDRAWN
}

enum PricingTier {
  STARTER
  GROWTH
  PREMIUM
}

enum InquiryStatus {
  NEW
  CONTACTED
  QUALIFIED
  NOT_INTERESTED
  CLOSED
}

// Secure Info Memo System
model InfoMemo {
  id          String   @id @default(cuid())
  businessId  String   @unique
  
  content     String   @db.Text  // AI-generated memo content
  videoUrl    String?  // Video walkthrough URL
  
  isPublished Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  accessCodes MemoAccess[]
  documents   MemoDocument[]
  sections    InfoMemoSection[]
}

model MemoAccess {
  id          String   @id @default(cuid())
  memoId      String
  
  buyerName   String
  buyerEmail  String
  accessCode  String   @unique  // Unique code for this buyer
  tier        AccessTier @default(TIER_1)
  
  isRevoked   Boolean  @default(false)
  expiresAt   DateTime?
  
  createdAt   DateTime @default(now())
  lastViewedAt DateTime?
  viewCount   Int      @default(0)
  
  memo        InfoMemo @relation(fields: [memoId], references: [id], onDelete: Cascade)
  viewLogs    MemoViewLog[]
  prospect    Prospect?   @relation(fields: [prospectId], references: [id])
  prospectId  String?     @unique
  
  @@index([accessCode])
  @@index([memoId, isRevoked])
}

model MemoViewLog {
  id          String   @id @default(cuid())
  accessId    String
  
  viewedAt    DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  
  access      MemoAccess @relation(fields: [accessId], references: [id], onDelete: Cascade)
}

// Confidential Documents (Tier 2)
model MemoDocument {
  id          String   @id @default(cuid())
  memoId      String
  
  name        String   // "BAS Statement Q3 2025"
  category    DocumentCategory
  fileUrl     String   // Storage URL
  fileSize    Int?
  mimeType    String?
  
  uploadedAt  DateTime @default(now())
  
  memo        InfoMemo @relation(fields: [memoId], references: [id], onDelete: Cascade)
}

enum DocumentCategory {
  FINANCIALS      // P&L, Balance Sheet
  TAX             // BAS statements, tax returns
  LEASE           // Lease agreements
  LICENSES        // Business licenses, permits
  CONTRACTS       // Supplier contracts, employment
  OTHER
}

enum AccessTier {
  TIER_1          // Basic info memo
  TIER_2          // Full confidential access
}

// Prospect CRM
model Prospect {
  id          String   @id @default(cuid())
  businessId  String
  
  name        String
  email       String
  phone       String?
  mobile      String?
  address     String?
  company     String?
  message     String?
  
  source      String   @default("direct")  // direct, seek, bizbuy, etc.
  sourceRef   String?  // External reference ID
  
  ndaStatus   NdaStatus @default(PENDING)
  ndaSentAt   DateTime?
  ndaSignedAt DateTime?
  
  status      ProspectStatus @default(NEW)
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  memoAccess  MemoAccess?
  notes_list  ProspectNote[]
  
  @@index([businessId, status])
  @@index([email])
}

enum NdaStatus {
  PENDING     // NDA not yet sent
  SENT        // NDA sent, awaiting signature
  SIGNED      // NDA signed
  DECLINED    // Prospect declined NDA
}

enum ProspectStatus {
  NEW         // Just came in
  CONTACTED   // Seller reached out
  NDA_SIGNED  // Ready for info
  QUALIFIED   // Serious buyer
  NEGOTIATING // In discussions
  CLOSED_WON  // Deal done!
  CLOSED_LOST // Didn't work out
}

// Prospect Notes - timestamped activity log
model ProspectNote {
  id          String   @id @default(cuid())
  prospectId  String
  
  content     String   @db.Text
  
  createdAt   DateTime @default(now())
  
  prospect    Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  
  @@index([prospectId])
}

// Lead Capture - Price Guide leads before signup
model Lead {
  id              String   @id @default(cuid())
  
  // Contact info (captured first)
  name            String
  email           String
  phone           String?
  businessName    String?
  
  // Business details (captured second)
  industry        String?
  state           String?
  annualRevenue   Decimal?
  annualProfit    Decimal?
  yearsOperating  Int?
  ownerOperated   Boolean?
  
  // Result
  priceGuideResult Json?   // Store the calculated result
  
  // Tracking
  source          String   @default("price_guide")  // price_guide, landing, etc.
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  
  // Conversion
  convertedAt     DateTime?
  convertedUserId String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([email])
  @@index([source, createdAt])
}

// Rich data for Info Memo generation
model InfoMemoData {
  id          String   @id @default(cuid())
  businessId  String   @unique
  
  // === BUSINESS BASICS ===
  businessName      String
  tradingName       String?
  abn               String?
  entityType        String?    // Pty Ltd, Sole Trader, Partnership, Trust
  established       Int?       // Year
  industryCategory  String
  industrySubcategory String?
  
  // === LOCATION & PREMISES ===
  streetAddress     String?
  suburb            String
  state             String
  postcode          String
  locationType      String?    // Strip retail, Shopping centre, Industrial, Home-based
  premisesSqm       Int?
  leaseExpiry       DateTime?
  leaseRemainingYrs Int?
  rentPerAnnum      Decimal?
  rentReviewType    String?    // CPI, Fixed %, Market
  outgoingsIncluded Boolean?
  
  // === FINANCIAL PERFORMANCE ===
  // Current Year
  revenueCurrent    Decimal?
  costOfGoodsCurrent Decimal?
  grossProfitCurrent Decimal?
  wagesCurrent      Decimal?
  rentCurrent       Decimal?
  otherExpensesCurrent Decimal?
  ebitdaCurrent     Decimal?
  
  // Prior Year
  revenuePrior      Decimal?
  ebitdaPrior       Decimal?
  
  // Two Years Prior
  revenueTwoPrior   Decimal?
  ebitdaTwoPrior    Decimal?
  
  // Owner benefit
  ownerSalary       Decimal?
  ownerPerks        Decimal?   // Car, phone, travel, etc
  addBacks          String?    // Description of add-backs
  adjustedEarnings  Decimal?   // SDE / Adjusted EBITDA
  
  // Revenue breakdown
  revenueStreams    Json?      // [{name, amount, pct}]
  seasonalityNotes  String?
  topCustomerPct    Int?       // % revenue from top customer
  customerConcentration String? // Description
  
  // === OPERATIONS ===
  operatingHours    String?
  daysPerWeek       Int?
  peakTimes         String?
  
  // Staff
  ftEmployees       Int?
  ptEmployees       Int?
  casualEmployees   Int?
  keyRoles          String?    // Description of key positions
  ownerHoursPerWeek Int?
  managerInPlace    Boolean?
  
  // Systems & processes
  posSystem         String?
  accountingSoftware String?
  otherSystems      String?
  documentedProcesses Boolean?
  
  // Suppliers
  keySuppliers      String?
  supplierTerms     String?
  exclusiveAgreements Boolean?
  
  // === ASSETS ===
  ffeMktValue       Decimal?   // Furniture, fixtures, equipment
  ffeAge            String?
  stockAtValue      Decimal?
  stockIncluded     Boolean?
  vehiclesIncluded  String?
  ipIncluded        String?    // Trademarks, patents, domain, recipes
  licensesRequired  String?    // Liquor, food, trade licenses
  
  // === SALE DETAILS ===
  askingPrice       Decimal?
  priceInclStock    Boolean?
  priceInclTraining Boolean?
  trainingPeriod    String?    // e.g. "4 weeks"
  reasonForSale     String
  idealBuyer        String?
  
  // === GROWTH & OPPORTUNITY ===
  competitiveAdvantages String?
  growthOpportunities   String?
  recentImprovements    String?
  challengesToNote      String?
  
  // === VIDEO ===
  videoUrl          String?   // YouTube, Vimeo, or hosted video URL
  videoTitle        String?   // e.g. "Business Walkthrough"
  videoDescription  String?   // Brief description of what the video shows

  // === VISIBILITY SETTINGS ===
  // JSON object tracking which fields to show in the IM
  // e.g. {"askingPrice": true, "revenueCurrent": false, ...}
  fieldVisibility   Json?     @default("{}")

  // === META ===
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// Section-by-section memo content
model InfoMemoSection {
  id          String   @id @default(cuid())
  memoId      String
  
  sectionKey  String   // executive_summary, business_overview, financials, etc.
  sectionTitle String
  sortOrder   Int
  
  content     String   @db.Text
  isLocked    Boolean  @default(false)  // User has approved this section
  
  generatedAt DateTime @default(now())
  editedAt    DateTime?
  
  memo        InfoMemo @relation(fields: [memoId], references: [id], onDelete: Cascade)
  
  @@unique([memoId, sectionKey])
  @@index([memoId, sortOrder])
}

// IM (Information Memorandum) - WYSIWYG page
model IMSection {
  id          String   @id @default(cuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sectionType String   // hero, overview, operations, financials, growth, assets, staff, lease, gallery
  title       String
  content     String?  @db.Text
  order       Int
  mediaUrls   String[] // photos/videos for this section
  isVisible   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([businessId])
}

model IMView {
  id          String   @id @default(cuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  buyerEmail  String
  buyerName   String?
  sectionType String?  // null = whole page view
  viewedAt    DateTime @default(now())
  duration    Int?     // seconds spent
  ipAddress   String?
  userAgent   String?

  @@index([businessId])
}

model IMAccess {
  id          String    @id @default(cuid())
  businessId  String
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  buyerEmail  String    // also the password
  buyerName   String?
  granted     Boolean   @default(true)
  grantedAt   DateTime  @default(now())
  revokedAt   DateTime?
  lastViewed  DateTime?
  viewCount   Int       @default(0)

  @@index([businessId])
  @@index([buyerEmail])
}
